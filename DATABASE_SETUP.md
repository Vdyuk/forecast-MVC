# Настройка базы данных для GVS Monitoring

## Описание изменений

Система была обновлена для работы с реальными данными из базы данных PostgreSQL. Теперь используются две основные таблицы:

### Таблица `status_houses`
- `id` - первичный ключ
- `id_house` - ID дома (int8)
- `unom` - УНОМ (int8)
- `status_incident` - статус инцидента (varchar50): Work, Repair, Null, New, Resolved
- `house_health` - состояние дома (text): Green, Yellow, Red

### Таблица `lublino_houses_id`
- `id` - первичный ключ
- `address` - адрес
- `district` - район
- `id_house` - ID дома (int8)
- `n_fias` - ФИАС код
- `nreg` - регион
- `simple_address` - упрощенный адрес
- `unom` - УНОМ (int8)

## Настройка

### 1. Переменные окружения

Создайте файл `.env` в папке `backend/`:

```env
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_HOST=localhost
DB_PORT=5432
DB_NAME=your_db_name
OPENROUTER_API_KEY=your_openrouter_key
```

### 2. Инициализация базы данных

```bash
cd backend
python init_db.py
```

### 3. Заполнение данными

После создания таблиц необходимо заполнить их данными:

```sql
-- Пример данных для status_houses
INSERT INTO status_houses (id_house, unom, status_incident, house_health) VALUES
(1, 1001, 'Work', 'Red'),
(2, 1002, NULL, 'Green'),
(3, 1003, 'New', 'Yellow'),
(4, 1004, 'Resolved', 'Green'),
(5, 1005, 'Repair', 'Red');

-- Пример данных для lublino_houses_id
INSERT INTO lublino_houses_id (address, district, id_house, n_fias, nreg, simple_address, unom) VALUES
('ул. Ленина, 1', 'Люблино', 1, '7700000000000000001', '77', 'Ленина, 1', 1001),
('ул. Пушкина, 5', 'Люблино', 2, '7700000000000000002', '77', 'Пушкина, 5', 1002),
('ул. Садовая, 10', 'Люблино', 3, '7700000000000000003', '77', 'Садовая, 10', 1003),
('ул. Тверская, 15', 'Люблино', 4, '7700000000000000004', '77', 'Тверская, 15', 1004),
('ул. Арбат, 20', 'Люблино', 5, '7700000000000000005', '77', 'Арбат, 20', 1005);
```

## Изменения в интерфейсе

### DashboardPage.tsx
- Отображает реальные данные по количеству домов с разными статусами
- **Критический инцидент**: `house_health = 'Red'` (11 домов)
- **Предупреждение**: `house_health = 'Yellow'` (20 домов)
- **Нет проблем**: `house_health = 'Green'` (2184 дома)
- **В работе**: `status_incident` не null (138 домов)
- **Сбои за сегодня**: только текущие проблемы (31 дом)
- **Обработано**: дома в работе или на реконструкции (27 домов)

### StatusListPage.tsx
- Показывает только необходимые колонки: **УНОМ**, **Адрес**, **Текущий статус**, **Действия**
- Убраны лишние поля: район, дата проблемы, тип сбоя, суть проблемы
- Добавлен параметр **УНОМ**
- **Исключены статусы**: Resolved и None (показываются только активные инциденты)
- **Активные статусы**: Work (В работе), Repair (На реконструкции), New (Новый)
- Фильтр по статусу инцидента обновлен для новых значений

## API изменения

Все эндпоинты теперь работают с реальными данными из базы:

- `/api/regions/{region_id}/dashboard` - метрики дашборда (реальные данные)
- `/api/regions/{region_id}/houses` - список домов (только активные инциденты)
- `/api/houses/{house_id}` - детали дома
- `/api/regions/{region_id}/houses/export` - экспорт данных (включает УНОМ)
- `/api/regions/{region_id}/failures-by-day` - графики сбоев (замороженные данные для демонстрации)

## Особенности реализации

### Графики сбоев
- Данные заморожены для демонстрации (не генерируются каждый раз)
- Показывают реалистичные данные за 14 дней
- Включают разбивку по типам: температура, расход, комплексный

### Фильтрация данных
- Исключены статусы "Resolved" и "None" из отображения
- Показываются только активные инциденты: Work, Repair, New
- Все дома в списке имеют статус "in_work"

## Запуск

1. Убедитесь, что PostgreSQL запущен
2. Создайте базу данных
3. Настройте переменные окружения (скопируйте `env_example.txt` в `.env`)
4. Запустите инициализацию: `python init_db.py`
5. Заполните таблицы тестовыми данными: `python seed_data.py`
6. Запустите backend: `uvicorn app.main:app --reload`
7. Запустите frontend: `npm run dev`

## Проверка работы

1. Откройте http://localhost:3000
2. На дашборде должны отображаться реальные данные из базы
3. Перейдите в список домов - должны отображаться УНОМ, адрес и статус
4. Экспорт должен включать колонку УНОМ
