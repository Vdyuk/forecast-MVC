# Система мониторинга ГВС

Рекомендательный сервис прогнозирования возникновения технологических ситуаций для АО "Мосводоканал".

## Описание

Система предназначена для автоматического анализа больших объемов ретроспективных и данных в режиме реального времени, формирования предупреждений о потенциальных проблемах в системе горячего водоснабжения.

### Основные функции

1. **Раннее выявление аномалий**
   - Постоянный мониторинг расхода с использованием датчиков в реальном времени
   - Автоматическое обнаружение отклонений от штатных режимов
   - Выявление потенциальных угроз и сбоев в работе оборудования

2. **Прогнозирование рисков методами машинного обучения**
   - Анализ исторических данных и текущих показателей
   - Построение моделей, предсказывающих вероятность порывов
   - Учет комбинации факторов (сезонные нагрузки, изменения потребления, внешние воздействия)

3. **Снижение социально-экономических последствий**
   - Предотвращение масштабных разрывов за счет своевременного вмешательства
   - Сокращение расходов на обслуживание оборудования
   - Повышение уровня комфорта жителей города Москвы

4. **Управление инцидентами**
   - Возможность создания, обновления и отслеживания статусов инцидентов для домов.
   - Интеграция с системой уведомлений (email).

5. **Интеграция с LLM**
   - Возможность задавать вопросы о конкретном доме или по всем домам в районе с использованием языковой модели.
   - Используется OpenRouter API (DeepSeek).

## Технологический стек

### Backend
- **Python 3.8+**
- **FastAPI** - веб-фреймворк для создания API
- **Pydantic** - валидация данных
- **SQLAlchemy (Async)** - ORM для работы с базой данных
- **Uvicorn** - ASGI сервер
- **httpx** - асинхронный HTTP клиент для запросов к LLM API
- **smtplib** - для отправки email уведомлений

### Frontend
- **React 18** - библиотека для создания пользовательского интерфейса
- **TypeScript** - типизированный JavaScript
- **Vite** - инструмент сборки
- **Recharts (или другие)** - библиотека для визуализации (уточнить по коду)
- **React Router** - маршрутизация
- **axios** - HTTP клиент для взаимодействия с API
- **XLSX** - для экспорта в Excel

## Запуск с помощью Docker

### Backend

1. Убедитесь, что `Dockerfile` находится в папке `backend/`.
2. Перейдите в директорию `backend/`.
3. Соберите образ:
   `docker build -t gvs-backend .`
4. Запустите контейнер:
   `docker run -d -p 8000:8000 --name gvs-backend-container gvs-backend`

### Frontend

1. Убедитесь, что `Dockerfile` находится в папке `frontend/`.
2. Перейдите в директорию `frontend/`.
3. Соберите образ:
   `docker build -t gvs-frontend .`
4. Запустите контейнер:
   `docker run -d -p 3001:80 --name gvs-frontend-container gvs-frontend`


### Установка и запуск для локальной разработки

## Предварительные требования

Python 3.8+
Node.js 16+
npm или yarn
Доступ к базе данных PostgreSQL (для backend)
Настроенные переменные окружения (см. .env.example)

## Backend

1. Перейдите в директорию backend:

`cd backend`

2. Создайте и активируйте виртуальное окружение:

# Windows
`python -m venv venv`
`venv\Scripts\activate`
# macOS/Linux
`python3 -m venv venv`
`source venv/bin/activate`

3. Установите зависимости

`pip install -r requirements.txt`

4. Настройте переменные окружения (.env файл). Обязательные переменные:

OPENROUTER_API_KEY (для LLM)

EMAIL_USER, EMAIL_PASSWORD, SMTP_SERVER, SMTP_PORT, NOTIFICATION_EMAILS (для уведомлений)
DATABASE_URL (строка подключения к БД)

# Пример .env файла
DATABASE_URL=postgresql+asyncpg://user:password@localhost/dbname
SMTP_SERVER=smtp.example.com
SMTP_PORT=587
EMAIL_USER=your_email@example.com
EMAIL_PASSWORD=your_app_password
NOTIFICATION_EMAILS=email1@example.com,email2@example.com
OPENROUTER_API_KEY=your_openrouter_api_key

5. Запустите сервер:

`uvicorn app.main:app --reload --host 0.0.0.0 --port 8000`


## Frontend

1. Перейдите в директорию frontend:

`cd frontend`

2. Установите зависимости

`npm install`

3. Настройте переменные окружения (.env файл в папке frontend). Обязательная переменная

`VITE_API_URL=http://127.0.0.1:8000`

4. Запустите сервер разработки:

`npm run dev`

5. Откройте браузер и перейдите по адресу, указанному в терминале (обычно http://localhost:5173)

### Использование
## Авторизация
Система поддерживает демонстрационный вход:

`Логин: admin`
`Пароль: admin`

## Основные функции
1. Главная страница (Дашборд)
   Обзор состояния системы по районам (пока только Люблино).
   Статистика по цветовым индикаторам (красный, желтый, зеленый, в работе).
   нтеллектуальный чат-помощник с LLM (глобальный для района).
2. Детальная информация по дому
   Просмотр и обновление статуса дома и инцидента.
   Визуализация данных (через Grafana, на основе URL в коде).
   Чат-помощник с LLM, специфичный для дома.
   Отображение УНОМ, ФИАС, адреса и других данных.
   Просмотр истории ицидентов
3. Список домов по статусам
   Фильтрация по типу сбоя (красный, желтый, зеленый, в работе) и статусу инцидента.
   Поиск по адресу.
   Экспорт данных (CSV, Excel, PDF).
4. Управление инцидентами
   Модальное окно "Создать инцидент" позволяет выбрать дом (из списка lublino_houses_id) и задать статусы (Предупреждение, Критическийинцидент).
   Возможность обновления статуса на странице деталей дома.
   Автоматическая отправка email-уведомлений при изменении статуса на проблемный (красный/желтый).
5. История обучения моделей
   Модальное окно "История обучения" отображает историю переобучений (из таблицы model_relearn).
   Возможность запустить переобучение модели.
6. Сводная информаци по дому

### API Endpoints (Основные)
## Регионы:
GET /api/regions/{region_id}/dashboard - метрики дашборда для региона.
GET /api/regions/{region_id}/houses - список домов с фильтрами.
GET /api/regions/{region_id}/llm-context - контекст для LLM по региону.

## Дома:
GET /api/houses/{house_id} - детали дома.
GET /api/houses/{house_id}/status-detail - детали статуса дома.
POST /api/houses/{house_id}/status - обновление статуса дома.
POST /api/houses/{house_id}/ask-llm - вопрос к LLM о конкретном доме.

## LLM:
POST /api/ask-llm - вопрос к LLM о всех домах в регионе.
GET /api/regions/{region_id}/llm-context 

## Инциденты:
GET /api/v2/houses/options - получить список всех домов для выбора при создании инцидента.
POST /api/v2/incidents/create - создать/обновить инцидент (v2).

## Модели/Обучение:
GET /api/model-relearn/history - получить историю переобучений.
POST /api/model-relearn/start - запустить переобучение.

## Прочее:
GET /health - проверка состояния API.
GET /db-health - проверка состояния базы данных.

### Архитектура

## Backend (FastAPI)
backend/
├── app/
│   ├── __init__.py
│   ├── main.py          # Основное приложение FastAPI и API endpoints
│   ├── schemas.py       # Pydantic модели данных (DashboardMetrics, HouseDetail и т.д.)
│   ├── models.py        # SQLAlchemy ORM модели (StatusHealth, LublinoHousesId и т.д.)
│   ├── database.py      # Настройка подключения к БД
│   ├── real_data.py     # Функции для получения данных из БД (get_real_dashboard_metrics и т.д.)
│   └── ...              # Другие модули (например, для работы с LLM, email)
├── .env                 # Файл с переменными окружения (не включается в репозиторий)
├── requirements.txt     # Список зависимостей Python
└── Dockerfile           # (если используется Docker)

## Frontend (React + TypeScript)

frontend/
├── src/
│   ├── modules/
│   │   ├── App.tsx                    # Главное приложение (маршрутизация, модальные окна)
│   │   ├── auth/                     # Модуль аутентификации (LoginPage, UserInfo)
│   │   ├── dashboard/                # Дашборд (DashboardPage)
│   │   ├── house/                    # Детали дома (HouseDetailPage)
│   │   ├── status/                   # Список домов (StatusListPage)
│   │   └── ...                       # Другие страницы/модули
│   ├── components/                   # Переиспользуемые компоненты (ThemeToggle, LLMChatWidget, GrafanaChart и т.д.)
│   ├── contexts/                     # React Context (например, ThemeContext)
│   ├── main.tsx
│   └── styles.css                    # Стили (возможно, используются CSS переменные)
├── .env                                # Файл с переменными окружения для frontend (не включается в репозиторий)
├── package.json
├── vite.config.ts
└── Dockerfile                          # (если используется Docker)


## Особенности реализации

# Машинное обучение / LLM
   Интеграция с LLM: Используется API OpenRouter для ответов на вопросы пользователей.
   Контекст для LLM: Система собирает данные по домам (статусы, расход, отклонения) для предоставления LLM контекста.
   Переобучение: Имеется эндпоинт для запуска переобучения и история в БД (model_relearn).
# Уведомления
   Email: При изменении статуса дома на проблемный (красный/желтый) отправляется email-уведомление на указанные адреса.

## Добавление новых функций
   Backend: Добавьте новые endpoints в main.py, обновите schemas.py и models.py при необходимости, реализуйте бизнес-логику в отдельных модулях (например, real_data.py или новом).
   Frontend: Создайте новые компоненты страниц или модулей, добавьте маршруты в App.tsx, используйте axios для взаимодействия с новыми API endpoints.

Проект разработан в соответствии с требованиями АО "Мосводоканал" для решения задач мониторинга системы ГВС.

